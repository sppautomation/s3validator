= S3 Object Storage Provider Validation
for IBM Spectrum Protect Plus
// For displaying images in GitHub, we need to specify the absolute URL
// for the images directory. For everything else, we specify a relative path.
ifdef::env-github[]
:imagesdir: https://raw.githubusercontent.com/SidBB/s3validator/sidbb_doc/Document/images
endif::[]
ifndef::env-github[]
:imagesdir: ./images
endif::[]
:doctype: book
:toc: left
:toclevels: 3
:icons: font
:pagenums:
:sectnums:
:pdf-page-size: letter
:source-highlighter: highlight.js

image::IBM-logo.png[IBM-logo]

NOTE: Copyright 2019 IBM. All rights reserved. The contents of this document and any attachments are strictly confidential and are supplied on the understanding that they will be held confidentially and not disclosed to third parties without the prior written consent of IBM.

<<<

== Introduction

This document describes the automated functional and performance tests that you can
run to validate that a cloud object storage provider is compatible with IBM Spectrum Protect Plus.

Running these tests will verify that IBM Spectrum Protect Plus can successfully offload data to and restore from an S3-compatible storage provider. The tests will also allow you to measure performance and analyze how well the solution scales.

<<<

== Basics

IBM Spectrum Protect Plus (SPP) works by writing data to vSnap servers which serve as the primary backup destination. Data in vSnap servers can then be offloaded/copied to S3-compatible object storage providers using an incremental forever approach.

A typical deployment usually consists of one SPP server which acts as the control plane, plus one or more vSnap servers which store data.

SPP is distributed as a pre-built virtual appliance that can be deployed in VMware or Hyper-V environments. vSnap can be similarly deployed as a pre-built virtual appliance, or it can be installed on a custom physical or virtual Linux system that meets certain pre-requisites.

In order to run the validation tests, you do not need to set up an SPP server, but you must at least install and configure a vSnap server, as described in the `Prerequisites` section.

The validation tests work by generating a random set of data, writing it to the vSnap server's disk-based storage pool, and then offloading/copying the data to the object storage. The tests also restore data by downloading it from object storage and verifying that its contents are valid.

<<<

== Prerequisites

Set up a vSnap server by deploying a virtual appliance or running the installer on a custom Linux system. For simplicity and ease of deployment, using the virtual appliance is highly recommended.

Detailed instructions for installing, configuring, and managing a vSnap server can be found https://www.ibm.com/support/knowledgecenter/en/SSNQFQ_10.1.5/spp/t_spp_install_vsnap.html[here].

The key steps required for configuring the vSnap server for the purpose of the validation tests are summarized below.

=== Initial deployment

* Deploy the vSnap OVA in a VMware environment using the `Deploy OVF Template` option.
* Enter network properties for the virtual machine as part of the deployment wizard, or leave them blank to use DHCP. You can also configure the network properties at a later time once the virtual machine is up and running.
* Once deployment completes, before powering on the virtual machine, edit its settings to adjust the virtual hardware. The following values are recommended for a system intended for the validation tests:
** Number of vCPUs: 8
** Total Memory: 40 GB
** Number of network adapters: 1
** Note: Using a 10 Gbit network adapter is recommended.
* Power on the virtual machine and login using the default credentials:
** Username: `serveradmin`
** Password: `sppDP758-SysXyz`
* Upon initial login, you are prompted to change the default password. Enter the default password first, then enter the new password twice. You may be forced to log out and log back in after changing the password.

NOTE: The `serveradmin` user has `sudo` privileges.

=== Configuring network

If you did not previously configure the network properties, you can do so by running `sudo nmtui` while logged in as the `serveradmin` user.

=== Configuring storage

For the purpose of running the validation tests you must configure two storage areas:

* The primary disk-based storage pool where data is initially written.
* A disk-based cache area where data is temporarily staged while it is being offloaded/copied from the primary storage pool to the object storage.

*Primary storage pool*

By default, the vSnap virtual appliance includes an unused 100 GB SCSI disk which can be used to create the storage pool. If you plan to run basic tests to verify functionality and/or measure performance using a data set that is smaller than 100 GB, it is sufficient to use the default disk to create the storage pool. If you plan to test with larger data sets, you may want to attach additional disks to create a larger storage pool.

Run `vsnap disk show` to list disks and confirm that one or more unused disks are available. The sample output below shows one unused 100 GB disk (`/dev/sdb`):

----
[serveradmin@vsnap ~]$ vsnap disk show
UUID                             | TYPE | VENDOR | MODEL        | SIZE     | USED AS     | KNAME | NAME
-----------------------------------------------------------------------------------------------------------
6000c29c116da8f495b2039fcd7fa3c3 | SCSI | VMware | Virtual disk | 70.00GB  | LVM2_member | sda   | /dev/sda
6000c293f48c897ded5c3b50afb7ca28 | SCSI | VMware | Virtual disk | 100.00GB | unused      | sdb   | /dev/sdb
6000c294c22b7968054789932dcf6621 | SCSI | VMware | Virtual disk | 128.00GB | LVM2_member | sdc   | /dev/sdc
----

To use a storage pool larger than 100 GB, attach one or more additional disks to the system, run `vsnap disk rescan` and then rerun `vsnap disk show` to confirm that they are all recognized as being unused.

To create a storage pool using all available unused disks, run `vsnap system init`.

Afterwards, run `vsnap pool show` to confirm that a storage pool has been created.

Sample output:

----
[serveradmin@vsnap ~]$ vsnap pool show
TOTAL: 1

ID: 1
NAME: primary
POOL TYPE: raid0
STATUS: ONLINE
HEALTH: 100
COMPRESSION: Yes
COMPRESSION RATIO: 1.00
DEDUPLICATION: No
DEDUPLICATION RATIO: 1.00
ENCRYPTION:
    ENABLED: No

TOTAL SPACE: 99.99GB
FREE SPACE: 96.39GB
USED SPACE: 3.60GB
DATA SIZE BEFORE DEDUPLICATION: 134.50KB
DATA SIZE BEFORE COMPRESSION: 53.50KB
CREATED: 2020-01-06 20:19:33 UTC
UPDATED: 2020-01-06 20:19:33 UTC
DISKS PER RAID GROUP: 1
DISKS IN POOL:
    RAID0:
        /dev/sdb1
----



*Cache area*

TODO

=== Setting up the validation test scripts



* The test scripts will be run locally on a vSnap. To deploy and initialize a vSnap use the following link:



** Install vSnap: https://www.ibm.com/support/knowledgecenter/en/SSNQFQ_10.1.5/spp/t_spp_install_vsnap.html[install]



** Initialize vSnap: https://www.ibm.com/support/knowledgecenter/en/SSNQFQ_10.1.5/spp/t_spp_config_vsnap_initialize.html[initialize]



** Expand vSnap pool (if needed): https://www.ibm.com/support/knowledgecenter/en/SSNQFQ_10.1.5/spp/t_spp_expand_storage_pool.html[expand_pool]

* Install git on the vSnap to clone the s3validator repo. Running the following commands on the vSnap will give you access to
the test scripts locally on your freshly deployed vSnap.

[source, bash]
----
$ sudo apt-get install git

$ git clone https://github.com/sppautomation/s3validator.git
----


* install environment to run the scripts.
**  Run the script "install.sh" that is in the s3validator directory.
** This will set up a Python virtual environment and will install some
dependencies that are necessary to run tests. Note that packages will
be installed into the newly created virtual environment so no changes
will be made to host's software.

[source, bash]
----
$ ./install.sh
----




<<<
== Configuration

The test scripts are divided into three categories as follows:

. Functional - These tests will run offload and restore using the registered s3 provider
. Performance - This test will tell us the throughput for a base offload and restore
. Scale - This test allows us to measure performance of the vSnap by varying the number of offloads it handles concurrently

=== Configuring S3 Provider

* To run tests, you need to first provide the details of the S3
provider. To do this, edit the following file:

    tests/config/cloud_endpoint.json

and provide the following information:

* endpoint ->  URL of the S3 provider.
* api_key -> Access key to be used to login.
* api_secret -> Password for the key provided above.
* bucket -> Bucket name.
* provider ->  You can use the default value.

=== Test Configuration

In directory tests update the pytest.ini file to set the offload size in MB's. Following are the fields you can configure, the default values are
mentioned for reference.

* Total time out (10800 seconds)

* Functional
** Base offload (10 MB)
** Incremental offload (5 MB)
** Number of increments (3)


* Performance
** Base offload size (1000 MB)

* Scale
** Base offload Size (10 MB)
** Number of offloads (10)
** Max vsnap streams (3)


<<<
== Test execution

Run the tests form the s3validator directory:

* Functional:

[source, bash]
----
$ ./runtests.sh functional
----

sample output:
image:functionaloutput.png[Functional test output]

* Performance:

[source, bash]
----
$ ./runtests.sh performance
----
sample output:
image:scaleoutput.png[Scale test output]

* Scale:

[source, bash]
----
$ ./runtests.sh scale

----
sample output:
image:performanceoutput.png[Performance test output]



The script will print information on the console as it runs each
test. Information about tests (such as APIs called and any errors) is
saved in the following two files:

* apiscalled.log
* test-results.xml

In case of any errors, please provide these files to IBM for
debugging.




